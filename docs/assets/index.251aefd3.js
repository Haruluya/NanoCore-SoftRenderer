import{V as E,B as R,i as X,d as q,n as G,r as L,u as F,j as J,m as T,k as W,_ as K,o as Q,b as N,e as b}from"./index.36e2076f.js";import{E as P,P as ee}from"./poloygon.960524dd.js";import{P as H}from"./point.4d2fb8c9.js";const O=9999;let w=[],Z=0;const ae=(t,h)=>{Z=t;for(let a=0;a<t*h;a++)w.push(-1*O)},$=()=>{for(let t=0;t<w.length;t++)w[t]=-1*O},U=(t,h,a,r)=>{let f=t.data;if(h>t.width||h<0||a>t.height||a<0)return;h=Math.floor(h),a=Math.floor(a);const o=(h+a*t.width)*4;f[o+0]=r.X,f[o+1]=r.Y,f[o+2]=r.Z,f[o+3]=255},j=(t,h,a,r,f)=>{let o=[[...r[0]],[...r[1]],[...r[2]]],C=[[...a[0]],a[1],a[2]];const s=new ee(a);if(s.size()<3)return;let i,p=0,n=0,u,c,m,l,x,Y,y={},I=[],D=[],M,_,v;x=s.minPointY(),Y=s.maxPointY(),l=Y-x;for(let d=0;d<s.size();d++)d<s.size()-1?(M=s.indexValue(d),_=s.indexValue(d+1)):(M=s.indexValue(d),_=s.indexValue(0)),M.Y>_.Y&&(m=M,M=_,_=m),M.Y!=_.Y&&(v=new P(M.X,(_.X-M.X)/(_.Y-M.Y),_.Y-1),y[M.Y-x]||(y[M.Y-x]=[]),y[M.Y-x].push(v));for(let d=0;d<l;d++){if(u=d+x,y[d]&&y[d].forEach(g=>{I.push(g)}),y[d]=null,I)for(let g=0;g<I.length;)I[g].Ymax<u?I.splice(g,1):g++;if(I){for(I.forEach(g=>{D.push(g.X),g.X=g.X+g.Dx}),D.sort(),i=0;i<D.length;i++)i%2==0&&(c=D[i],D[i]-c?p=c+1:p=c,n=D[i+1]),le(t,h,new H(p,u),new H(n,u),C,o,f);D=[]}}y=[]};let V=new E(0,0,0),e=new E(0,0,0);const le=(t,h,a,r,f,o,C)=>{let s=null,i,p,n=0,u=-.5,c=[],m=0;if(a[1]==r[1]){for(a[0]>r[0]&&(s=a,a=r,r=s),p=a[0];p<r[0];p++){e[0]=p,e[1]=a[1],e.Z=0,c=R(f[0],f[1],f[2],e);for(let l=0;l<3;l++)e.Z+=f[l][2]*c[l],V[l]=o[0][l]*c[0]+o[1][l]*c[1]+o[2][l]*c[2];m=X(V,h),w[Math.floor(e[0]+e[1]*Z)]<e.Z&&(w[Math.floor(e[0]+e[1]*Z)]=e.Z,U(t,e[0],e[1],C.mutiply(m)))}return}if(a[0]==r[0]){for(a[1]>r[1]&&(s=a,a=r,r=s),n=a[1];n<r[1];n++){e[0]=a[0],e[1]=n,e.Z=0,c=R(f[0],f[1],f[2],e);for(let l=0;l<3;l++)e.Z+=f[l][2]*c[l],V[l]=o[0][l]*c[0]+o[1][l]*c[1]+o[2][l]*c[2];m=X(V,h),w[Math.floor(e[0]+e[1]*Z)]<e.Z&&(w[Math.floor(e[0]+e[1]*Z)]=e.Z,U(t,e[0],e[1],C.mutiply(m)))}return}if(i=(r[1]-a[1])/(r[0]-a[0]),i>0&&i<=1)for(a[0]>r[0]&&(s=a,a=r,r=s),u=-.5,p=a[0],n=a[1];p<r[0];){{e[0]=p,e[1]=n,e.Z=0,c=R(f[0],f[1],f[2],e);for(let l=0;l<3;l++)e.Z+=f[l][2]*c[l],V[l]=o[0][l]*c[0]+o[1][l]*c[1]+o[2][l]*c[2];m=X(V,h),w[Math.floor(e[0]+e[1]*Z)]<e.Z&&(w[Math.floor(e[0]+e[1]*Z)]=e.Z,U(t,e[0],e[1],C.mutiply(m)))}u=u+i,u>0&&(n++,u=u-1),p++}else if(i>=-1&&i<0)for(a[0]>r[0]&&(s=a,a=r,r=s),u=.5,p=a[0],n=a[1];p<r[0];){{e[0]=p,e[1]=n,e.Z=0,c=R(f[0],f[1],f[2],e);for(let l=0;l<3;l++)e.Z+=f[l][2]*c[l],V[l]=o[0][l]*c[0]+o[1][l]*c[1]+o[2][l]*c[2];w[Math.floor(e[0]+e[1]*Z)]<e.Z&&(w[Math.floor(e[0]+e[1]*Z)]=e.Z,U(t,e[0],e[1],C.mutiply(m)))}u=u+i,u<0&&(n--,u=u+1),p++}else if(i>1)for(a[1]>r[1]&&(s=a,a=r,r=s),u=-.5,p=a[0],n=a[1];n<r[1];){{e[0]=p,e[1]=n,e.Z=0,c=R(f[0],f[1],f[2],e);for(let l=0;l<3;l++)e.Z+=f[l][2]*c[l],V[l]=o[0][l]*c[0]+o[1][l]*c[1]+o[2][l]*c[2];m=X(V,h),w[Math.floor(e[0]+e[1]*Z)]<e.Z&&(w[Math.floor(e[0]+e[1]*Z)]=e.Z,U(t,e[0],e[1],C.mutiply(m)))}u=u+1/i,u>0&&(p=p+1,u=u-1),n++}else for(a[1]>r[1]&&(s=a,a=r,r=s),u=.5,p=a[0],n=a[1];n<r[1];){{e[0]=p,e[1]=n,e.Z=0,c=R(f[0],f[1],f[2],e);for(let l=0;l<3;l++)e.Z+=f[l][2]*c[l],V[l]=o[0][l]*c[0]+o[1][l]*c[1]+o[2][l]*c[2];m=X(V,h),w[Math.floor(e[0]+e[1]*Z)]<e.Z&&(w[Math.floor(e[0]+e[1]*Z)]=e.Z,U(t,e[0],e[1],C.mutiply(m)))}u=u+1/i,u<0&&(p--,u=u+1),n++}},te=t=>{let h=/^#([0-9a-fA-f]{3}|[0-9a-fA-f]{6})$/,a=t.toLowerCase();if(h.test(a)){if(a.length===4){let f="#";for(let o=1;o<4;o+=1)f+=a.slice(o,o+1).concat(a.slice(o,o+1));a=f}let r=[];for(let f=1;f<7;f+=2)r.push(parseInt("0x"+a.slice(f,f+2)));return r}else return[0,0,0]},re={category:"SoftwareRenderer",name:"Camera",buttonContent:"\u67E5\u770B\u6E90\u7801",title:"\u76F8\u673A\u4E0E\u53D8\u6362",content:"Camera and transform."},oe=q({name:"Camera",components:{nano_cg_experiment_page:G},setup(){const t=L();let h,a,r=L(),f,o,C,s=[],i=!1;const p=()=>{var Y,y;h=t.value.getCanvas(),a=t.value.getContext(),r=t.value.getModel(),f=t.value.getImgData(),o=t.value.getSectionParams(),C=(Y=r.value)!=null&&Y.getVertByFaceMap?(y=r.value)==null?void 0:y.getVertByFaceMap:(I,D)=>E;const x=new E(0,0,1);ae(h.width,h.height),t.value.addParam({name:"lightDir",value:x}),t.value.addUIItem({type:"slider-vector",id:"lightDir",value:o.lightDir,min:{0:-100,1:-100,2:-100},max:{0:100,1:100,2:100},callback:F.globalUiCallbacks.updateVector3(o,t.value.Render,"lightDir")}),t.value.addUIItem({type:"slider-vector",id:"translation",value:o.transform.translation,min:{0:-300,1:-300,2:-300},max:{0:300,1:300,2:300},callback:F.globalUiCallbacks.updateChildVector3(o,t.value.Render,"transform","translation")}),t.value.addUIItem({type:"slider-vector",id:"rotation",value:o.transform.rotation,min:{0:-300,1:-300,2:-300},max:{0:300,1:300,2:300},callback:F.globalUiCallbacks.updateChildVector3(o,t.value.Render,"transform","rotation")}),t.value.addUIItem({type:"slider-vector",id:"scale",value:o.transform.scale,min:{0:-200,1:-200,2:-200},max:{0:200,1:200,2:200},callback:F.globalUiCallbacks.updateChildVector3(o,t.value.Render,"transform","scale")})},n=()=>{t.value.caculateMatrix(),u[t.value.getDrawModel()]()},u={ImgData:()=>{f=a.createImageData(h.width,h.height),c(j,j,[f]),a.putImageData(f,0,0)}},c=(x,Y,y)=>{var g;const I=te(o.color);let D=new E(I[0],I[1],I[2]),M=t.value.getMvpMatrix(),_=new E(o.lightDir[0],o.lightDir[1],o.lightDir[2]),v=[],d=new E(0,0,0);if(i)console.log("with cache"),$(),s.forEach(k=>{v=[];for(let B=0;B<3;B++)d=T(W(M,k.worldPoints[B].getMatrix())),v.push(d.getVec3().toIntVec());j(f,_,v,k.vertNormals,D)});else{let k=[],B=[];(g=r.value)==null||g.facetVrt.forEach((ce,z)=>{var S;v=[],k=[],B=[];for(let A=0;A<3;A++)d=new J(C.call(r.value,z,A),1),k.push(d),d=T(W(M,d.getMatrix())),v.push(d.getVec3().toIntVec()),B.push((S=r.value)==null?void 0:S.getNormalByFaceMap(z,A));s.push({worldPoints:k,vertNormals:B}),x(...y,_,v,B,D)}),i=!0}};return{desData:re,page:t,Init:p,Render:n,ModelChange:()=>{$(),s=[],i=!1},DrawModelChange:x=>{console.log("change model"),$(),s=[],i=!1,x()}}}});function fe(t,h,a,r,f,o){const C=b("nano_cg_experiment_page");return Q(),N(C,{prop_des_data:t.desData,prop_page_config:{mutiMode:!1,offset:!1},onInit:t.Init,onRender:t.Render,onModelChange:t.ModelChange,onDrawModelChange:t.DrawModelChange,ref:"page"},null,8,["prop_des_data","onInit","onRender","onModelChange","onDrawModelChange"])}const he=K(oe,[["render",fe]]);export{he as default};

import{f as T,V as i,B as V,i as I,d as U,n as q,r as G,u as J,_ as K,o as Q,b as z,e as N}from"./index.a15bf386.js";import{E as b,P}from"./poloygon.960524dd.js";import{P as L}from"./point.6a53762d.js";const _=9999;let y=[],g=[];const $=t=>{console.log(t),y=t.normals,g=t.points};let M=[],Z=0,W=0;const ee=(t,l)=>{Z=t,W=l;for(let a=0;a<t*l;a++)M.push(-1*_)},S=()=>{for(let t=0;t<M.length;t++)M[t]=-1*_},x=(t,l,a,n)=>{let o=t.data;if(l>t.width||l<0||a>t.height||a<0)return;l=Math.floor(l),a=Math.floor(a);const f=(l+a*t.width)*4;o[f+0]=n.X,o[f+1]=n.Y,o[f+2]=n.Z,o[f+3]=255},le=(t,l,a,n)=>{let o=Math.floor(n/l),f=Math.floor(a/l);for(let u=0;u<o;u++)t.beginPath(),t.moveTo(0,l*u),t.lineTo((f-1)*l,l*u),t.strokeStyle="#ccc",t.stroke();for(let u=0;u<f;u++)t.beginPath(),t.moveTo(l*u,0),t.lineTo(l*u,(o-1)*l),t.strokeStyle="#ccc",t.stroke()},ae=(t,l,a,n)=>{let o=l,f=new T(-1*_,-1*_),u=new T(_,_),X=new T(Z-1,W-1);for(let e=0;e<3;e++)for(let h=0;h<2;h++)u[h]=Math.max(0,Math.min(u[h],Math.floor(o[e][h]))),f[h]=Math.min(X[h],Math.max(f[h],Math.floor(o[e][h])));let s=new i(0,0,0),p=new i(0,0,0),Y=new i(0,0,0);for(s.X=u.X;s.X<=f.X;s.X++)for(s.Y=u.Y;s.Y<=f.Y;s.Y++){if(Y=V(o[0],o[1],o[2],s),Y.X<0||Y.Y<0||Y.Z<0)continue;s.Z=0;for(let h=0;h<3;h++)s.Z+=o[h][2]*Y[h],p[h]=a[0][h]*Y[0]+a[1][h]*Y[1]+a[2][h]*Y[2];let e=I(p,new i(0,0,1));M[Math.floor(s.X+s.Y*Z)]<s.Z&&(M[Math.floor(s.X+s.Y*Z)]=s.Z,H(t,s.X,s.Y,n.mutiply(e)),y.push([p.X,p.Y,p.Z]),g.push([s.X,s.Y,s.Z]))}},H=(t,l,a,n)=>{t.fillStyle="rgb("+n.X+","+n.Y+","+n.Z+")",t.fillRect(l,a,1,1)},te=(t,l,a,n)=>{const o=new P(l);if(o.size()<3)return;let f,u=0,X=0,s,p,Y,e,h,c,w={},r=[],B=[],m,C,E;h=o.minPointY(),c=o.maxPointY(),e=c-h;for(let d=0;d<o.size();d++)d<o.size()-1?(m=o.indexValue(d),C=o.indexValue(d+1)):(m=o.indexValue(d),C=o.indexValue(0)),m.Y>C.Y&&(Y=m,m=C,C=Y),m.Y!=C.Y&&(E=new b(m.X,(C.X-m.X)/(C.Y-m.Y),C.Y-1),w[m.Y-h]||(w[m.Y-h]=[]),w[m.Y-h].push(E));for(let d=0;d<e;d++){if(s=d+h,w[d]&&w[d].forEach(D=>{r.push(D)}),w[d]=null,r)for(let D=0;D<r.length;)r[D].Ymax<s?r.splice(D,1):D++;if(r){for(r.forEach(D=>{B.push(D.X),D.X=D.X+D.Dx}),B.sort(),f=0;f<B.length;f++)f%2==0&&(p=B[f],B[f]-p?u=p+1:u=p,X=B[f+1]),oe(t,new L(u,s),new L(X,s),l,a,n);B=[]}}w=[]},oe=(t,l,a,n,o,f)=>{let u=null,X,s,p=0,Y=-.5,e=new i(0,0,0),h=new i(0,0,0),c=new i(0,0,0),w=0;if(l.Y==a.Y){for(l.X>a.X&&(u=l,l=a,a=u),s=l.X;s<a.X;s++){e.X=s,e.Y=l.Y,e.Z=0,h=V(n[0],n[1],n[2],e);for(let r=0;r<3;r++)e.Z+=n[r][2]*h[r],c[r]=o[0][r]*h[0]+o[1][r]*h[1]+o[2][r]*h[2];w=I(c,new i(0,0,1)),M[Math.floor(e.X+e.Y*Z)]<e.Z&&(M[Math.floor(e.X+e.Y*Z)]=e.Z,y.push([c.X,c.Y,c.Z]),g.push([e.X,e.Y,e.Z]),x(t,e.X,e.Y,f.mutiply(w)))}return}if(l.X==a.X){for(l.Y>a.Y&&(u=l,l=a,a=u),p=l.Y;p<a.Y;p++){e.X=l.X,e.Y=p,e.Z=0,h=V(n[0],n[1],n[2],e);for(let r=0;r<3;r++)e.Z+=n[r][2]*h[r],c[r]=o[0][r]*h[0]+o[1][r]*h[1]+o[2][r]*h[2];w=I(c,new i(0,0,1)),M[Math.floor(e.X+e.Y*Z)]<e.Z&&(M[Math.floor(e.X+e.Y*Z)]=e.Z,y.push([c.X,c.Y,c.Z]),g.push([e.X,e.Y,e.Z]),x(t,e.X,e.Y,f.mutiply(w)))}return}if(X=(a.Y-l.Y)/(a.X-l.X),X>0&&X<=1)for(l.X>a.X&&(u=l,l=a,a=u),Y=-.5,s=l.X,p=l.Y;s<a.X;){{e.X=s,e.Y=p,e.Z=0,h=V(n[0],n[1],n[2],e);for(let r=0;r<3;r++)e.Z+=n[r][2]*h[r],c[r]=o[0][r]*h[0]+o[1][r]*h[1]+o[2][r]*h[2];w=I(c,new i(0,0,1)),M[Math.floor(e.X+e.Y*Z)]<e.Z&&(M[Math.floor(e.X+e.Y*Z)]=e.Z,y.push([c.X,c.Y,c.Z]),g.push([e.X,e.Y,e.Z]),x(t,e.X,e.Y,f.mutiply(w)))}Y=Y+X,Y>0&&(p++,Y=Y-1),s++}else if(X>=-1&&X<0)for(l.X>a.X&&(u=l,l=a,a=u),Y=.5,s=l.X,p=l.Y;s<a.X;){{e.X=s,e.Y=p,e.Z=0,h=V(n[0],n[1],n[2],e);for(let r=0;r<3;r++)e.Z+=n[r][2]*h[r],c[r]=o[0][r]*h[0]+o[1][r]*h[1]+o[2][r]*h[2];w=I(c,new i(0,0,1)),M[Math.floor(e.X+e.Y*Z)]<e.Z&&(M[Math.floor(e.X+e.Y*Z)]=e.Z,y.push([c.X,c.Y,c.Z]),g.push([e.X,e.Y,e.Z]),x(t,e.X,e.Y,f.mutiply(w)))}Y=Y+X,Y<0&&(p--,Y=Y+1),s++}else if(X>1)for(l.Y>a.Y&&(u=l,l=a,a=u),Y=-.5,s=l.X,p=l.Y;p<a.Y;){{e.X=s,e.Y=p,e.Z=0,h=V(n[0],n[1],n[2],e);for(let r=0;r<3;r++)e.Z+=n[r][2]*h[r],c[r]=o[0][r]*h[0]+o[1][r]*h[1]+o[2][r]*h[2];w=I(c,new i(0,0,1)),M[Math.floor(e.X+e.Y*Z)]<e.Z&&(M[Math.floor(e.X+e.Y*Z)]=e.Z,y.push([c.X,c.Y,c.Z]),g.push([e.X,e.Y,e.Z]),x(t,e.X,e.Y,f.mutiply(w)))}Y=Y+1/X,Y>0&&(s=s+1,Y=Y-1),p++}else for(l.Y>a.Y&&(u=l,l=a,a=u),Y=.5,s=l.X,p=l.Y;p<a.Y;){{e.X=s,e.Y=p,e.Z=0,h=V(n[0],n[1],n[2],e);for(let r=0;r<3;r++)e.Z+=n[r][2]*h[r],c[r]=o[0][r]*h[0]+o[1][r]*h[1]+o[2][r]*h[2];w=I(c,new i(0,0,1)),M[Math.floor(e.X+e.Y*Z)]<e.Z&&(M[Math.floor(e.X+e.Y*Z)]=e.Z,y.push([c.X,c.Y,c.Z]),g.push([e.X,e.Y,e.Z]),x(t,e.X,e.Y,f.mutiply(w)))}Y=Y+1/X,Y<0&&(s--,Y=Y+1),p++}},re=(t,l,a,n)=>{let o=0,f=new i(0,0,0),u=new i(0,0,0);g.forEach((X,s)=>{u.X=X[0],u.Y=X[1],u.Z=X[2],f.X=y[s][0],f.Y=y[s][1],f.Z=y[s][2],o=I(f,n),x(t,u.X+a.x,u.Y+a.y,l.mutiply(o))})},fe=(t,l,a,n)=>{let o=0,f=new i(0,0,0);g.forEach((u,X)=>{f.X=y[X][0],f.Y=y[X][1],f.Z=y[X][2],o=I(f,n),H(t,u[0]+a.x,u[1]+a.y,l.mutiply(o))})},he=(t,l,a,n,o)=>{let f=0,u=new i(0,0,0);g.forEach((X,s)=>{u.X=y[s][0],u.Y=y[s][1],u.Z=y[s][2],f=I(u,o),O(t,l,X[0]+n.x,X[1]+n.y,a.mutiply(f))})},ne=(t,l,a,n,o)=>{let f=a,u=new T(-1*_,-1*_),X=new T(_,_),s=new T(Z-1,W-1);for(let h=0;h<3;h++)for(let c=0;c<2;c++)X[c]=Math.max(0,Math.min(X[c],Math.floor(f[h][c]))),u[c]=Math.min(s[c],Math.max(u[c],Math.floor(f[h][c])));let p=new i(0,0,0),Y=new i(0,0,0),e=new i(0,0,0);for(p.X=X.X;p.X<=u.X;p.X++)for(p.Y=X.Y;p.Y<=u.Y;p.Y++){if(e=V(f[0],f[1],f[2],p),e.X<0||e.Y<0||e.Z<0)continue;p.Z=0;for(let c=0;c<3;c++)p.Z+=f[c][2]*e[c],Y[c]=n[0][c]*e[0]+n[1][c]*e[1]+n[2][c]*e[2];let h=I(Y,new i(0,0,1));M[Math.floor(p.X+p.Y*Z)]<p.Z&&(M[Math.floor(p.X+p.Y*Z)]=p.Z,O(t,l,p.X,p.Y,o.mutiply(h)),y.push([Y.X,Y.Y,Y.Z]),g.push([p.X,p.Y,p.Z]))}},O=(t,l,a,n,o)=>{if(a>Math.floor(Z/l)-1||a<0||n>Math.floor(W/l)-1||n<0)return;let f=a*l,u=n*l;t.fillStyle="rgb("+o[0]+","+o[1]+","+o[2]+")",t.fillRect(f,u,l,l)},se=t=>{let l=/^#([0-9a-fA-f]{3}|[0-9a-fA-f]{6})$/,a=t.toLowerCase();if(l.test(a)){if(a.length===4){let o="#";for(let f=1;f<4;f+=1)o+=a.slice(f,f+1).concat(a.slice(f,f+1));a=o}let n=[];for(let o=1;o<7;o+=2)n.push(parseInt("0x"+a.slice(o,o+2)));return n}else return[0,0,0]},ue={category:"SoftwareRenderer",name:"ZBuffer",buttonContent:"\u67E5\u770B\u6E90\u7801",title:"Z\u7F13\u51B2",content:"Visualization of zbuffer."},ce=U({name:"ZBuffer",components:{nano_cg_experiment_page:q},setup(){const t=G();let l,a,n=G(),o,f,u,X,s=!1;const p=()=>{var B,m;l=t.value.getCanvas(),a=t.value.getContext(),n=t.value.getModel(),o=t.value.getImgData(),f=t.value.getSectionParams(),u=t.value.getWorldToScreen,X=(B=n.value)!=null&&B.getVertByFaceMap?(m=n.value)==null?void 0:m.getVertByFaceMap:(C,E)=>i;const r=new i(0,0,1);ee(l.width,l.height),t.value.addParam({name:"lightDir",value:r}),t.value.addUIItem({type:"slider-vector",id:"lightDir",value:f.lightDir,min:{0:-100,1:-100,2:-100},max:{0:100,1:100,2:100},callback:J.globalUiCallbacks.updateVector3(f,t.value.Render,"lightDir")})},Y=()=>{e[t.value.getDrawModel()]()},e={Grid:()=>{le(a,f.girdSize,l.width,l.height);let r=f.girdSize;h(ne,he,[a,r])},ImgData:()=>{o=a.createImageData(l.width,l.height),h(te,re,[o]),a.putImageData(o,0,0)},CanvasApi:()=>{h(ae,fe,[a])}},h=(r,B,m)=>{var d;const C=se(f.color);let E=new i(C[0],C[1],C[2]);if(s){console.log("with cache");let D=t.value.getOffset(),A=new i(f.lightDir[0],f.lightDir[1],f.lightDir[2]);B(...m,E,D,A)}else{let D=[],A=[],k=new i(0,0,0),v=[];(d=n.value)==null||d.facetVrt.forEach((Ye,F)=>{var j;D=[],A=[],v=[];for(let R=0;R<3;R++)k=X.call(n.value,F,R),A.push(k),D.push(u(k)),v.push((j=n.value)==null?void 0:j.getNormalByFaceMap(F,R));r(...m,D,v,E)}),s=!0}};return{desData:ue,page:t,Init:p,Render:Y,ModelChange:()=>{S(),$({normals:[],points:[]}),s=!1},DrawModelChange:r=>{console.log("change model"),S(),$({normals:[],points:[]}),s=!1,r()}}}});function pe(t,l,a,n,o,f){const u=N("nano_cg_experiment_page");return Q(),z(u,{prop_des_data:t.desData,onInit:t.Init,onRender:t.Render,onModelChange:t.ModelChange,onDrawModelChange:t.DrawModelChange,ref:"page"},null,8,["prop_des_data","onInit","onRender","onModelChange","onDrawModelChange"])}const Ze=K(ce,[["render",pe]]);export{Ze as default};
